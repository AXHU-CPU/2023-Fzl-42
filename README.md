顺序单发射五级流水线CPU
---------------

CPU 设计除了实现延迟槽技术，尽量减少了流水线气泡的产生外，还设计了伪 Dcache（历史数据记录堆）。

【设计说明】
---
设计的伪 Dcache 采用全相联的地址映射策略 和 LRU（最近最少使用）替换策略。  
在测试通过的最高主频下，伪 Dcache 可存储数据的容量为 16B，即4个32位数据，容量特别小。  
这主要是因为采用了全相联、LRU策略后，需要设计大量的计数器和选择器，使得在延迟增大，后续开发者可尝试修改策略进行优化。

【解释】
---
之所以说是“伪 Dcache”，是因为该 cache 不具备写回功能，且该 cache 的功能是记录历史中写入 ExtRAM 中的数据，
尽可能减少因为 load 数据相关现象而暂停流水线的问题。
（PS:load 数据相关现象指，id 模块需要的数据存在上一条指令，且上一条指令是 load 指令，需要的数据还未从sram 中取出）

【设计补充说明】
---
实际上，cache并不适合在普通的（经典的）流水线CPU上设计。这里具体指单周期取指访存的流水线CPU，例如雷思磊的《自己动手写CPU》，即取出指令或者存储指令都需要一个周期。  
虽然我在比赛时采用了这种设计，但其实在性能测试中发挥的作用不大，当然要考虑过大的逻辑电路会影响时序，具体原因往后看吧。  

在一个时钟周期内，若访问cache和访问存储器是同时进行的，访问cache的时间一般小于访问存储器的时间，则一个时钟周期的时长一定要按照最大的算，即以访问存储器为准，才能保证两件事都能在一个时钟周期完成。假设cache能命中，即使cache能先得到数据，CPU也还是要继续等完这个时钟周期的剩余时间才能让指令进行下一级流水，并且这些剩余时间内，存储器也一定能得到数据，那么cache的设计形同虚设。  

同样，若是串行的，先访问cache，再访问存储器，即访问cache用了一个时钟周期，在下一个时钟周期再访问存取器，时钟周期的长度则依旧取用时最长的，即还是以存储器用时为一个时钟周期。这种情况下，无cache设计的CPU原本是五级流水，这种设计的情况下，取指和访存都需要各加一级流水，变为了七级，并且时钟周期均以访问存储器时长为准，则后者完成任务的时长更长。

在比赛时，我的第一想法是希望能尽量减少暂停流水线现象，具体解决load 数据相关现象才提出设计的。  
当时这样设计，也夹杂着想过官方那边的代码查重准备的。  
当然，创新设计的前提是为了追求更高的性能，不能为新而新，这没意义，也丧失了比赛的意义。  
我们在追求更高性能的同时，自然而然会想出解决之法，这便开始了创新。  

一开始设计Cache的数据存储容量是32个数据，但延迟太大了，没法通过性能测试。只能去尝试缩小容量，通过实验发现，最多存4个数据可以通过测试。  
后来进行写法上的优化，删去了大量冗余的逻辑（一些刚开始设计时写了一堆不起作用的语句，后来优化发现可以删去，简化逻辑，并且功能正确），得以提升主频，迈进了60Mhz+。  
那么删去“伪cache”的逻辑，是否可以继续提频？
我试着关闭该“伪Dcache”的命中功能，即我让命中信号一直为“失败”，性能测试用时是一样的，说明没有命中，可能是因为存储的数据容量太小了，没起作用。也可能是测试的指令没有出现这种load 数据相关现象。  
我尝试把这个“伪Dcache”的设计删除，发现测试没法通过了，只有降点时钟频率才能过。  
vivado的玄学现象，可能我前面的设计正好平衡了我的CPU时序，后面修改打破了这种平衡吧。  
所以不建议大家在普通流水线CPU上去模仿我的这个设计。  

大赛的频率分为两个层次。  
由于片外存储器SRAM的访问时长限制，使得选手设计的CPU分为60MHz及以下、100Mhz及以上的两个层次；这两种层次其实对应着不同的架构设计，即是否采用多周期取指访存，这里先卖个关子；初次参加大赛的选手，一般对照雷思磊的《自己动手写CPU》，设计出经典的五级流水线CPU，主频达到60Mhz左右，并且通过了代码查重，基本上进决赛不成问题，即国三稳了。

大赛的CPU设计，已然划分成了两条路子，高频和双发射。  
高频指CPU的时钟具有很高的频率，目前有人已经从60MHz左右的层次，晋升过百的层次了，较低的100MHz、较高的200MHz、300MHz。  
双发射是超标量CPU（顺序/乱序 多发射 流水线 CPU）的一种，通过将CPU从一条流水扩展成两条流水线同时进行处理，设计难度高。  
当然，今年（24年）已经有人尝试了将两条路子结合，高频的顺序双发射流水线CPU。  
相比较起来，这里我简单介绍一下高频的设计思路，回应上面卖的关子，将取指、访存阶段分别修改为多周期，即在取指阶段和访存阶段都需要状态机进行管理，让原本一个周期的时间长度，分为多个周期，一般两、三个周期，即将周期缩短，时钟变快。后面具体看25年我的作品吧，期待一下吧！

【CPU总体设计图】
---
![image](https://github.com/user-attachments/assets/b9cf2e8b-6eed-4773-8d99-10e664ce9671)

【工程说明】
---
工程包含CPU设计代码和所有引脚约束，可以直接编译。

代码中包含中文注释，Vivado下可能出现乱码问题，为了保证显示正确
Windows平台请使用GBK编码的文件，Linux平台请使用UTF-8编码的文件。  


## 注

1. 如有问题请直接在FPGA学习群中联系me
2. 多来点建议呀！！！~~（不然我怎么更新~~

---

## PS: 如果觉得好用，请star以示鼓励
